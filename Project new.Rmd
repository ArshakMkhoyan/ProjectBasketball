---
title: "Project Basketball Probabilities"
author: "Arshak Mkhoyan"
date: "11/10/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(stringr)
library(tidyr)
library(shiny)
library(dplyr)
library(ggplot2)
```

#Analysis of Basketball Games. Predictivity of game outcome.
#Introduction
The main goal of this paper is to find probabilities of winning the game for home and away team given the results of first, second, and third periods. We will concentrate on the difference of the points scored in these periods. At the same time, we will check the hypothesis whether the teams that win the first period tend to win the whole game. 
```{r, include=FALSE}
load("bxsum2.rda")
end_period=data_frame()
for (i in 1:14597){
ss <- bxsum2[[i]]$resultSets$rowSet[[6]]
colnames(ss) <- bxsum2[[i]]$resultSets$headers[[6]]
#creating cumulative point
points=t(ss[,9:12])
colnames(points)=c('Home.Points', 'Away.Points')
points=as.data.frame(points)
points[,1]=as.numeric(as.character(points[,1]))
points[,2]=as.numeric(as.character(points[,2]))
for (k in 4:2){
  for (z in 1:2){
    points[k,z]=sum(points[1:k,z])
  }
}
points$Period=c(1:4)
#Add game id
game_id=data_frame(game.id=rep(as.character(ss[,3]), times=2))
#Teams names
team_names=data_frame(home=rep(as.character(ss[1,5]), times=4),away=rep(as.character(ss[2,5]), times=4))
#Year added
year_game=data.frame(year=rep(ss[1,1]%>%ymd_hms()%>%year(), times=4))
#binding all frames
full_data=bind_cols(game_id,year_game, team_names, points)
end_period=bind_rows(end_period,full_data)
}
end_period=mutate(end_period, Diff.Points=abs(Away.Points-Home.Points))%>%
  select(game.id:away, Period, Home.Points:Diff.Points)%>%
  mutate(result=ifelse(Home.Points>Away.Points,'home',ifelse(Away.Points>Home.Points,'away','draw')))

#Just to make sure we structured home and away teams' names right, we get their names and game ids from a different place and mach them with the ones we created above.
final=data_frame()
for (i in c(2005:2017)){
df <- SportsAnalytics270::getBoxScore(i)
df$GAME_ID <- as.character(df$GAME_ID)
df$H <-ifelse(str_detect(df$MATCHUP, '@')==TRUE, 'A', 'H') 
df=df%>% select(GAME_ID, TEAM_ABBREVIATION, H)%>%spread(H, TEAM_ABBREVIATION)
final=bind_rows(final, df)
}
a=left_join(end_period, final, by=c("game.id"="GAME_ID"))
same=identical(a$home,a$H)
#It appeared they are the same!!!
#Taking games that had draw in 4th period out.
end_period_noDraws_id=end_period%>%filter(Period==4, result=='draw')%>%select(game.id)
  end_period_noDraws=anti_join(end_period, end_period_noDraws_id, by='game.id')
```
#Data description
For the purposes described above, the data for 14597 basketball games, starting from 2005 to 2017, was collected. For the simplicity of calculation, I excluded the games that had a draw in 4th. There were 903 games that went overtime. 
You can find the structure of this data below.
```{r}
glimpse(end_period)
```
#Metadata
game.id: Game ids
year: The year when the game was played
home: home team abbreviations 
away: home team abbreviations
Period: Period of the game
Home.Points: Cumulative points scorded by home team at the end of each period 
Away.Points: Cumulative points scorded by away team at the end of each period 
Diff.Points: absolute value of points' difference for each period
result: Result of the period; either home, away, or draw







```{r}
find_diff=function (prob, period, team){
 i=1
 game_id1=end_period%>%
  filter(Period==period, Diff.Points==i)%>%
    select(game.id)
first_period10=end_period%>%
  filter(Period==period, Diff.Points==i)%>%
  select(result)
last_period10=semi_join(end_period, game_id1, by='game.id')%>%
  filter(Period==4)%>%
  select(result)
result_table10=as.matrix(table(first_period10$result,last_period10$result))
prob_total=(result_table10['away','away']+result_table10['home','home'])/sum(result_table10)
prob_home=result_table10['home','home']/sum(first_period10$result=='home')
prob_away=result_table10['away','away']/sum(first_period10$result=='away')
  if (tolower(team)=='home') {
    while(prob_home<prob) {
i=i+1
game_id1=end_period%>%
  filter(Period==period, Diff.Points==i)%>%
    select(game.id)
first_period10=end_period%>%
  filter(Period==period, Diff.Points==i)%>%
  select(result)
last_period10=semi_join(end_period, game_id1, by='game.id')%>%
  filter(Period==4)%>%
  select(result)
result_table10=as.matrix(table(first_period10$result,last_period10$result))
prob_total=(result_table10['away','away']+result_table10['home','home'])/sum(result_table10)
prob_home=result_table10['home','home']/sum(first_period10$result=='home')
}
  i
} else {
while(prob_away<prob) {
i=i+1
game_id1=end_period%>%
  filter(Period==period, Diff.Points==i)%>%
    select(game.id)
first_period10=end_period%>%
  filter(Period==period, Diff.Points==i)%>%
  select(result)
last_period10=semi_join(end_period, game_id1, by='game.id')%>%
  filter(Period==4)%>%
  select(result)
result_table10=as.matrix(table(first_period10$result,last_period10$result))
prob_total=(result_table10['away','away']+result_table10['home','home'])/sum(result_table10)
prob_away=result_table10['away','away']/sum(first_period10$result=='away')
}
  i
}}



find_diff(0.8, 2, 'away')
```


```{r}
#find probabilities
find_prob=function (dif, period, team){
game_id1=end_period%>%
  filter(Period==period, Diff.Points==dif)%>%
    select(game.id)
first_period10=end_period%>%
  filter(Period==period, Diff.Points==dif)%>%
  select(result)
last_period10=semi_join(end_period, game_id1, by='game.id')%>%
  filter(Period==4)%>%
  select(result)
result_table10=as.matrix(table(first_period10$result,last_period10$result))
prob_total=(result_table10['away','away']+result_table10['home','home'])/sum(result_table10)
prob_home=result_table10['home','home']/sum(first_period10$result=='home')
prob_away=result_table10['away','away']/sum(first_period10$result=='away')
if (tolower(team)=='home') {
  prob_home
} else {
  prob_away
}
}

find_prob(20, 3,'home')
find_prob(20, 3,'away')

df_prob=data.frame(period=c(1:120), difference=c(1:120), team=c(1:120), probability=c(1:120))
for (i in 1:3){
  for (k in 1:20){
    for(ha in c('home', 'away')){
      tm=ha=='home'
    df_prob$period[(i-1)*40+2*k-tm]=i
    df_prob$difference[(i-1)*40+2*k-tm]=k
    df_prob$team[(i-1)*40+2*k-tm]=ha
    df_prob$probability[(i-1)*40+2*k-tm]=find_prob(k, i,ha)
    }
  }
}

ggplot(df_prob1, aes(difference, probability, color= team))+geom_point()+geom_line()+facet_grid(~period)+geom_smooth(se=F)

end_period%>%filter(Period==1)%>%select(result)%>%table()
end_period%>%filter(Period==2)%>%select(result)%>%table()
end_period%>%filter(Period==3)%>%select(result)%>%table()
end_period%>%filter(Period==4)%>%select(result)%>%table()


Diff_Probs=(filter(df_prob, team=='away')%>%select(probability)-filter(df_prob, team=='home')%>%select(probability))%>%mutate(id=c(1:60))
ggplot(Diff_Probs, aes(x=id,y=probability))+geom_point()+ylab('Difference in probabilities')+xlab('Observations')+ggtitle('Difference in probabilities of winning for away and home')

total_games=end_period%>%filter(Period==c(1,2,3))%>%group_by(year, Period, Diff.Points, result)%>%summarise(Total=n())%>%filter(result!='draw')
First_per=total_games%>%filter(Period==1)
ggplot(First_per, aes(Diff.Points, Total, fill=result))+geom_col(position = 'fill')+facet_grid(~year)+ggtitle('1 Period difference frequency')
Second_per=total_games%>%filter(Period==2)
ggplot(Second_per, aes(Diff.Points, Total, fill=result))+geom_col(position = 'fill')+facet_grid(~year)+ggtitle('1 Period difference frequency')
Third_per=total_games%>%filter(Period==3)
ggplot(Third_per, aes(Diff.Points, Total, fill=result))+geom_col(position = 'fill')+facet_grid(~year)+ggtitle('1 Period difference frequency')
#то есть команды выигравали away, но проигравали дома
#Если ничья в 4, кто выйграет?
#look at the distribution and try to use it for prediction
#Suppose we have a game. One team is away, another is Home. Given the 
```

#Taking draws out
```{r}
end_period_noDraws_id=end_period%>%filter(Period==4, result=='draw')%>%select(game.id)
  end_period_noDraws=anti_join(end_period, end_period_noDraws_id, by='game.id')

  
find_prob1=function (dif, period, team){
game_id1=end_period_noDraws%>%
  filter(Period==period, Diff.Points==dif)%>%
    select(game.id)
first_period10=end_period_noDraws%>%
  filter(Period==period, Diff.Points==dif)%>%
  select(result)
last_period10=semi_join(end_period_noDraws, game_id1, by='game.id')%>%
  filter(Period==4)%>%
  select(result)
result_table10=as.matrix(table(first_period10$result,last_period10$result))
prob_total=(result_table10['away','away']+result_table10['home','home'])/sum(result_table10)
prob_home=result_table10['home','home']/sum(first_period10$result=='home')
prob_away=result_table10['away','away']/sum(first_period10$result=='away')
if (tolower(team)=='home') {
  prob_home
} else {
  prob_away
}
}

df_prob1=data.frame(period=c(1:120), difference=c(1:120), team=c(1:120), probability=c(1:120))
for (i in 1:3){
  for (k in 1:20){
    for(ha in c('home', 'away')){
      tm=ha=='home'
    df_prob1$period[(i-1)*40+2*k-tm]=i
    df_prob1$difference[(i-1)*40+2*k-tm]=k
    df_prob1$team[(i-1)*40+2*k-tm]=ha
    df_prob1$probability[(i-1)*40+2*k-tm]=find_prob1(k, i,ha)
    }
  }
}


```

#Linear function of probs
```{r}
home=c()
away=c()
for (h in c('home', 'away')){
for( i in 1:3){
for_lm=df_prob1%>%filter(period==i, team==h)
  a=lm(probability~difference, data=for_lm)
  if(h=='home'){
  home=c(home,coefficients(a)[2])}
  else {
  away=c(away, coefficients(a)[2])}
}
}
df_lm=data_frame(Team=c(rep('home', 3), rep('away',3)), Period=c(1:3,1:3), Coefficient=c(home, away))
ggplot(df_lm, aes(x=Period, y=Coefficient, color=Team))+geom_point()+geom_line()+scale_x_discrete(limits=c("1","2","3"))+ggtitle('Coeficients from regressing probabilities on point difference')
```


#Shiny APP
```{r}
ui <- fluidPage(
    titlePanel("Probability Computation"),
    sidebarLayout(
        sidebarPanel(
            selectInput(inputId = "team1",
                        label = "Winning team:",
                        choices = c("home", 'away')),
            
            selectInput(inputId = "period1",
                        label = "Period:",
                        choices = c("1", '2','3')),
        
            sliderInput(inputId = "Diff",
                        label = "Difference",
                        min = 1,
                        max = 20,
                        value = 5)
        ),
      
        mainPanel(
            tableOutput("values"),
            plotOutput("BarPlot"),
            plotOutput("ScatterPlot")  
            
        )
    )
)

server <- function(input, output) {
    
    sliderValues <- reactive({
        data.frame(
           Attribute= c("Team","Period","Difference","Probability"),
            Value=as.character(c(input$team1,input$period1, input$Diff,
            round(df_prob1%>%filter(period==as.numeric(input$period1), difference==as.numeric(input$Diff), team==input$team1)%>%select(probability), 3))),
            stringsAsFactors = FALSE)
        
    })
    
    output$values <- renderTable({
        sliderValues()
    })
    output$BarPlot <- renderPlot({
        game_id2=end_period_noDraws%>%
            filter(Period==as.numeric(input$period1), Diff.Points==as.numeric(input$Diff))%>%
            select(game.id)
        first_period12=end_period_noDraws%>%
            filter(Period==as.numeric(input$period1), Diff.Points==as.numeric(input$Diff))%>%
            select(result)
        last_period12=semi_join(end_period_noDraws, game_id2, by='game.id')%>%
            filter(Period==4)%>%
            select(result)
        result_table11=as.matrix(table(first_period12$result,last_period12$result))
        frame_=filter(as.data.frame(result_table11), Var1==input$team1)%>%select(Var2, Freq)
        ggplot(frame_, aes(x=Var2, y=Freq))+geom_col()+geom_text(aes(label=Freq), vjust=0)+xlab('Winning Team')+ylab('Number of Games')+ggtitle('Outcomes of games for given parameters')
    })
    output$ScatterPlot <- renderPlot({
      df_prob1%>%filter(period==as.numeric(input$period1), team==input$team1)%>%
      ggplot(aes(difference, probability))+ geom_point()+geom_line()+geom_vline(xintercept = as.numeric(input$Diff), linetype="dashed", color = "red")+geom_hline(yintercept =as.numeric(df_prob1%>%filter(period==as.numeric(input$period1), difference==as.numeric(input$Diff), team==input$team1)%>%select(probability)), linetype="dashed", color = "red")+ggtitle('Probability distribution for the given Winning team and Period')

    })
}

shinyApp(ui, server)
library('rsconnect')
```

